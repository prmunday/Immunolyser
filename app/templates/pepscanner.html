{% extends "layout.html" %}

{% block content %}
<br>

<div class="col">

  <!-- Section: Pepscanner -->
  <h3 class="mb-4">Pepscanner</h3>

  <div class="row align-items-start mb-5">
    <!-- Left: Heatmap or Image -->
    <div class="col-md-7 mb-3 mb-md-0">
      <img id="pepscannerimage" src="static/others/blankpepscanner.png" alt="Pepscanner heatmap" class="img-fluid rounded border">
    </div>

    <!-- Right: Metadata Table -->
    <div class="col-md-5">
      <div class="card w-100 h-100 shadow-sm">
        <div class="card-body">
          <h5 class="card-title">File metadata</h5>
          <h6 class="card-subtitle mb-3 text-muted">Statistics of proteins found in the Accession column</h6>

          <p class="card-text text-start" id="uniquepeptides"><strong>Unique proteins:</strong></p>

          <div class="table-container">
            <table class="table table-sm table-hover" style="table-layout: fixed; width: 100%;">
              <thead>
                <tr>
                  <th scope="col">Accession</th>
                  <th scope="col">Peptide count</th>
                  <th scope="col">Gene name</th>
                  <th scope="col">Species</th>
                  <th scope="col">Protein</th>
                </tr>
              </thead>
              <tbody id="topprotiens">
                <!-- Dynamic rows go here -->
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Section: ProtPeptigram -->
  <h3 class="mb-4">ProtPeptigram</h3>

  <div id="protpeptigram-container" class="mt-3"></div>

</div>

<form onSubmit="return submitPep();" id="pepscanner" action="{{ url_for('pepscanner') }}" method="post" enctype="multipart/form-data" novalidate>
    <!-- <label for="sample" hidden>Peptide File</label>  -->
    <!-- <input id="file" name="file" required type="file" class="col-md-6 mb-3">	 -->

    <div style="padding-left: 18px;" class="input-group mb-3">
      <div class="custom-file">
          <input type="file" class="custom-file-input" id="file" style="cursor: pointer;" name="file" required accept=".csv">
          <label class="custom-file-label" for="file" id="filename">Select the peptide File</label>
      </div>
      <i class="fa fa-question-circle" aria-hidden="true" style="cursor: pointer; padding-left: 10px; padding-top: 6px;" data-toggle="tooltip" data-placement="right" title="Please select an input csv file.&#013;The file should contain 'Peptide' and 'Accession' columns."></i>
    </div>

    <div style="padding-left: 18px;" class="input-group mb-3">
        <div class="custom-file">
            <input type="file" class="custom-file-input" id="background" style="cursor: pointer;" name="background" required accept=".fasta">
            <label class="custom-file-label" for="background">Select the background proteome fasta file (optional)</label>
        </div>
        <i class="fa fa-question-circle" aria-hidden="true" style="cursor: pointer; padding-left: 10px; padding-top: 6px;" data-toggle="tooltip" data-placement="right" title="Please select the background fasta file.&#013;This is the file you would download from UniProt as proteome from any species. If you don't upload this, the human proteome with proteins reviewed by UniProt (Swiss-Prot reviewed) will be used as the background."></i>
    </div>
    
    <div style="padding-left: 18px;" class="input-group mb-3">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" value="" id="runProtPeptigram" checked>

        <label class="form-check-label" for="runProtPeptigram">
          Run ProtPeptigram
        </label>
      </div>
      

      <i class="fa fa-question-circle" aria-hidden="true" style="cursor: pointer; padding-left: 10px; padding-top: 6px;" data-toggle="tooltip" data-placement="right" title="Tick this checkbox to run ProtPeptigram analysis. Uncheck to skip."></i>
    </div>
    
  
    <div class="col" style="padding-left: 18px;">
        <div style="display: flex; align-items: center;">
            <input type="text" class="form-control" id="proteinInput" placeholder="Type protein ID and press Enter" style="flex: 1; margin-right: 10px;">
            <input type="hidden" name="protein_ids" id="proteinHiddenInput">
            <button class="btn btn-primary" id="addProteinBtn">Add Protein ID</button>
        </div>
        <small class="form-text text-muted">Example: A0A024QYW1</small>
        <div class="mt-3" id="proteinList"></div>
        <div class="mt-3 text-danger" id="validationMessage"></div>
    </div>

    
    <input style="float: right; margin-right: 20px;" id="submit" name="submit" type="submit" class="btn btn-outline-secondary" value="Submit">
            
</form>
<br>
<br>
<br>
    <p class="text-justify" style="padding-right: 20px;">
      <strong>Pepscanner</strong> is a tool which can be used to visualise the location of peptides present in the proteins of interest. It takes a CSV (comma separated values) file as an input along with the proteins of interest (optional). The uploaded file should have 'Peptide' and 'Accession' columns present in it. Pepscanner first extracts the protein sequences from a reference human proteome file and then plots the location of all the peptides (from the 'Peptide' column) on the selected proteins. Users also have an option to upload their choice of FASTA file which will be used as the background if uploaded.<br>If the proteins are not entered, the top occurring five proteins present in the 'Accession' column are selected automatically. A demo output using the 'Liver Set1 DDA.csv' file in our demo datasets has been generated to demonstrate the usage of Pepscanner. It can be accessed by using <a id="myLink" action="{{ url_for('pepscanner') }}" href="#" onclick="return pepscannerDemo();">this link.</a>
    </p>

    <p class="text-justify" style="padding-right: 20px;">
      <strong>ProtPeptigram</strong> provides a comprehensive visualization platform for mapping immunopeptides to their source proteins across different biological samples. This tool enables users to identify peptide coverage patterns, analyze density distributions, and compare peptide presentations between experimental conditions.
    </p>

    <br>

<script>

    document.getElementById('file').onchange = function () {
        var name = document.getElementById('filename');
        name.innerHTML = 'Selected file: ' + this.files[0].name;
    };

    function pepscannerDemo(){
      submitPep(demo=true);
    }

    function submitPep(demo = false){

        showSpinner();

        var form = new FormData();

        if(demo == false){
          filevalidation = validatePeptideFile();
          if(filevalidation==false){
            return false;
          }

          protiens = document.getElementById('proteinHiddenInput').value;

          peptidevalidation = validatePeptides();
          if(peptidevalidation==false){
            return false;
          }

          fileInput = document.getElementById('file')
          background = document.getElementById('background');

          form.append("file", fileInput.files[0], fileInput.value);
          if (background.files.length > 0) {
              form.append("background", background.files[0], background.value);
          }
          form.append("protein_ids", protiens);
          form.append("runProtPeptigram", document.getElementById('runProtPeptigram').checked);
        }
        else {
          form.append("demo", true);
        }
        
        
        var settings = {
        "url": window.location.origin.concat('/api/pepscanner?t=') + new Date().getTime(),
        "method": "POST",
        "timeout": 0,
        "processData": false,
        "mimeType": "multipart/form-data",
        "contentType": false,
        "data": form
        };

        $.ajax(settings).done(function (response) {

          res = JSON.parse(response);

          taskId = res['taskId']
          fileName = res['fileName']
          peptigram = res['peptigram'];

          document.getElementById('pepscannerimage').src = "static/images/"+ taskId +"/pepscanner.png";
          
          let container = document.getElementById('protpeptigram-container');
          container.innerHTML = '';

          if (Array.isArray(peptigram) && peptigram.length > 0) {
              let tabList = document.createElement('ul');
              tabList.className = 'nav nav-tabs justify-content-center mb-3';
              tabList.id = 'peptigramTab';
              tabList.setAttribute('role', 'tablist');

              let tabContent = document.createElement('div');
              tabContent.className = 'tab-content';

              peptigram.forEach((imgPath, index) => {
                  // Extract protein name from filename (e.g. "protein_visualization_PROT1.png")
                  let match = imgPath.match(/protein_visualization_(.+)\.png$/);
                  let proteinName = match ? match[1] : `Protein ${index + 1}`;
                  let safeId = `prot-tab-${index}`;

                  // Create tab link
                  let tab = document.createElement('li');
                  tab.className = 'nav-item';
                  tab.innerHTML = `
                      <a class="nav-link ${index === 0 ? 'active' : ''}" id="${safeId}-tab" data-toggle="tab" href="#${safeId}" role="tab" aria-controls="${safeId}" aria-selected="${index === 0}">
                          ${proteinName}
                      </a>`;
                  tabList.appendChild(tab);

                  // Create tab pane
                  let content = document.createElement('div');
                  content.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
                  content.id = safeId;
                  content.setAttribute('role', 'tabpanel');
                  content.setAttribute('aria-labelledby', `${safeId}-tab`);
                  content.innerHTML = `
                      <div class="row justify-content-center">
                          <div class="col-auto text-center">
                              <img src="${imgPath}" class="img-fluid rounded border" alt="ProtPeptigram Image for ${proteinName}">
                          </div>
                      </div>`;
                  tabContent.appendChild(content);
              });

              container.appendChild(tabList);
              container.appendChild(tabContent);
          }

          console.log(res);

          unique_peptides = document.getElementById('uniquepeptides');
          unique_peptides.innerHTML = "Unique protiens: ".concat(res['unique_peptides']);

          top_protiens = document.getElementById('topprotiens');
          top_protiens.innerHTML = "";

          var sortable = [];
          for (var i in res['top_protiens']) {
              sortable.push([i, res['top_protiens'][i]]);
          }

          sortable.sort(function(a, b) {
              return b[1][0] - a[1][0];  // Sort by peptide count (value[0])
          });
          
          for (const [key, value] of sortable) {
              var row = document.createElement("tr");
              
              var cell1 = document.createElement("td");
              cell1.style.width = "25%";
              cell1.innerHTML = key;
              row.appendChild(cell1);

              var cell2 = document.createElement("td");
              cell2.style.width = "25%";
              // cell2.innerHTML = value;
              cell2.innerHTML = "<a href='static/images/"+taskId+"/protienandepeptides/"+fileName + " " +key+".csv'>"+value[0]+"</a>";
              row.appendChild(cell2);


              var cell3 = document.createElement("td");
              cell3.style.width = "25%";
              cell3.innerHTML = value[1];
              // getGeneName(key,data => console.log("The data is:", data));
              row.appendChild(cell3);

              var cell4 = document.createElement("td");
              cell4.style.width = "25%";
              cell4.innerHTML = value[2];
              row.appendChild(cell4);

              var cell5 = document.createElement("td");
              cell5.style.width = "25%";
              cell5.innerHTML = `<span title="${value[3]}">${value[3]}</span>`;
              row.appendChild(cell5);

              top_protiens.append(row);
              
          }

          showSpinner(false);

        })
        .fail(function (jqXHR, textStatus, errorThrown) {

          showSpinner(false);
          
        // Check if responseText is JSON and parse it
        try {
            let responseJSON = JSON.parse(jqXHR.responseText);
            if (responseJSON && responseJSON.error) {
                errorMessage = responseJSON.error;
            }
        } catch (e) {
            console.log("Failed to parse responseText as JSON:", e);
        }

          // Display an alert with error details
          alert("An error occurred:\n" +
                "Status: " + textStatus + "\n" +
                "Error: " + errorThrown + "\n" +
                "Response: " + errorMessage);
          });
        
        return false;
        
    }

    var col_warning = false
    var col_warning_2 = false
    cols = ['Peptide','Accession'];
    colsnotpresent = [];
    var name = '';

    function validatePeptideFile(){
      var peptidefile = document.getElementById('file');
      var runProtPeptigram = document.getElementById('runProtPeptigram');

      if(peptidefile.value == ''){
        showSpinner(false);
        alert('Please upload the peptide file.')
              return false;
      }

      // for(i=0;i<sample_files.files.length;i++){

      name = peptidefile.files[0].name;

      if(name.substr(-4)!='.csv'){
          showSpinner(false);
          alert('Cannot accept ' + name + ' file as it is not a csv file.');
          return false;
      }

      let reader = new FileReader();
      reader.readAsText(peptidefile.files[0]);

      reader.onload = function() {

        colseread = reader.result.split('\n')[0].replace('\r','').split(',');

        colseread = colseread.map(col => col.replace(/^"|"$/g, ''));

        for (i=0;i<cols.length;i++){

            flag = false;

            for (j=0;j<colseread.length;j++){
                if(colseread[j] !== cols[i]){
                    continue;
                }
                else{
                    flag = true;
                }
            }

            if(!flag){
                colsnotpresent.push(cols[i]);
            }

        }
        if(colsnotpresent.length != 0) {
            col_warning = true;
        }

        // Also look for columns starting with 'Intensity_'
        let hasIntensity = colseread.some(col => col.startsWith('Intensity_'));
        if (!hasIntensity) {
            col_warning_2 = true;
        }   

       
      };

      if (col_warning){
          col_warning=false;
          showSpinner(false);
          alert(name + ' does not contains following column(s): '+ colsnotpresent.join(', '));
          colsnotpresent = [];
          return false;
      }

      // Check for Intensity_ columns only if checkbox is ticked
      if (runProtPeptigram.checked && col_warning_2) {
        
        col_warning_2 = false;
        showSpinner(false);
        alert(name + ' does not contain any column starting with "Intensity_". Uncheck "Run ProtPeptigram" option to proceed.');
        return false;
    
      }

      // }

      return true;
    }

    peptidewarning = true;

    function validatePeptides(){

      let protiens = document.getElementById('proteinList').textContent;

      if(protiens == ''){

              if (peptidewarning){
                  showSpinner(false);
                  alert("Please enter the proteins. By default, top five proteins present in the 'Accession' column will be used to generate the heatmap.")
                  peptidewarning = false;
                  return false;
              }    
              else{
                  return true;
              }
                  
      }

      return true;
	  }

    function getGeneName(key) {

      var xhr = new XMLHttpRequest();
      xhr.open("GET", "https://www.uniprot.org/uniprot/"+key+".fasta", false);
      xhr.send();

      for(; xhr.readyState !== 4;)

      if (xhr.status === 200) {

          // console.log('SUCCESS', xhr.responseText);

      } else console.warn('request_error');

      res = xhr.responseText;

      if (res != ''){
        return res.split('\n')[0].match(' GN=(.+?) ')[1];
      }
      else
        return '';   
    }

    function showSpinner(flag=true){
      var nodes = document.getElementById("main-content").getElementsByTagName('*');
      
      if(flag){
        // for(var i = 0; i < nodes.length; i++){
        // 	nodes[i].disabled = true;
        // }

        document.getElementById("main-content").style.opacity = 0.2;
        document.getElementById('lds-hourglass').hidden = false;
      }
      
      else{
        // for(var i = 0; i < nodes.length; i++){
        // 	nodes[i].disabled = false;
        // }

        document.getElementById("main-content").style.opacity = 1;
        document.getElementById('lds-hourglass').hidden = true;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('proteinInput');
      const button = document.getElementById('addProteinBtn');
      const proteinListDiv = document.getElementById('proteinList');
      const validationMessage = document.getElementById('validationMessage');
      const form = document.getElementById('pepscanner');

      const proteinRegex = /^[OPQ][0-9][A-Z0-9]{3}[0-9]|[A-NR-Z][0-9]([A-Z][A-Z0-9]{2}[0-9]){1,2}$/;
      let proteinList = [];

      function validateProtein(protein) {
          return proteinRegex.test(protein);
      }

      function updateProteinList() {
          proteinListDiv.innerHTML = ''; // Clear current list

          proteinList.forEach((protein, index) => {
              const badge = document.createElement('span');
              badge.className = 'badge badge-secondary mr-2';
              badge.style.cursor = 'default';
              badge.style.display = 'inline-flex';
              badge.style.alignItems = 'center';

              const textSpan = document.createElement('span');
              textSpan.textContent = protein;

              const removeBtn = document.createElement('span');
              removeBtn.innerHTML = '&nbsp;&times;';
              removeBtn.style.marginLeft = '8px';
              removeBtn.style.color = 'red';
              removeBtn.style.cursor = 'pointer';

              removeBtn.addEventListener('click', () => {
                  proteinList.splice(index, 1);
                  updateProteinList();
              });

              badge.appendChild(textSpan);
              badge.appendChild(removeBtn);
              proteinListDiv.appendChild(badge);
          });

          // Update hidden input with real protein list
          const hiddenInput = document.getElementById('proteinHiddenInput');
          if (hiddenInput) {
              hiddenInput.value = proteinList.join(',');
          }
      }



      function addProtein() {
          const protein = input.value.trim().toUpperCase();

          if (validateProtein(protein)) {
              if (!proteinList.includes(protein)) {
                  proteinList.push(protein);
                  updateProteinList();
                  validationMessage.textContent = '';
                  input.value = '';
              } else {
                  validationMessage.textContent = 'This access ID has already been added';
              }
          } else {
              validationMessage.textContent = 'Not a valid access ID';
          }
      }

      form.addEventListener('submit', function(event) {
          event.preventDefault();
      });

      button.addEventListener('click', function(event) {
          event.preventDefault();
          addProtein();
      });
    });

    // Method attached as event listner to make sure the upploaded background file is of fasta type
    document.getElementById('background').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const fileInputLabel = document.querySelector('label[for="background"]');
        if (file) {
            const fileName = file.name;
            const allowedExtensions = /\.fasta$/i;
            
            if (!allowedExtensions.exec(fileName)) {
                alert('Invalid file type. Please upload a FASTA file with a .fasta extension.');
                event.target.value = ''; // Clear the input
                fileInputLabel.textContent = 'Select the background FASTA file (optional)'; // Reset label text
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const fileContent = e.target.result;
                if (!fileContent.startsWith('>')) {
                    alert('Invalid file format. The file does not appear to be a FASTA file.');
                    event.target.value = ''; // Clear the input
                    fileInputLabel.textContent = 'Select the background FASTA file (optional)'; // Reset label text
                }
            };
            reader.readAsText(file);
        }
    });

</script>

{% endblock %}
