{% extends "layout.html" %}

{% block content %}


<br>

<div class="container">
	<form onSubmit="return checkAlleles();" id="login" action="" method="post" enctype="multipart/form-data" novalidate>
		
		<div>
			<h4>Data Input</h4>
			<div class="form-row">
				<div class="col-md-6 mb-3">Sample Name 
					<i class="fa fa-question-circle" aria-hidden="true" style="cursor: pointer;" data-toggle="tooltip" data-placement="right" title="Name of the sample.&#013;Make sure that all the samples have unique names and do NOT contain any special characters."></i>
				</div>
				<div class="col-md-6 mb-3">Sample Files 
					<i class="fa fa-question-circle" aria-hidden="true" style="cursor: pointer;" data-toggle="tooltip" data-placement="right" title="Select input csv file. The file should contain column named 'Peptide'.&#013;Select multiple files in case of more than one replicates are needed."></i>
				</div>
			</div>
			<div id="samples">
				<div id="sample" class="form-row">
					<label for="sample_name" hidden>Sample</label> 
					<input id="sample_name-1" name="sample-1" required type="text" value="" class="col-md-6 mb-3">
					<br>
					<label for="sample_file-1" hidden>Peptide File</label> 
					<input id="sample_file-1" multiple name="sample-1" required type="file" class="col-md-6 mb-3" onchange="calculateNumberOfPeptidesInCsv(event)">    
				</div>
			</div>
			<input id="add_sample" name="add_sample" type="button" value="Add Sample" onclick="addSample()">
			<input id="remove_sample" name="remove_sample" type="button" value="Remove Sample" onclick="deleteSample()">
		</div>

		<br>

		<div>
			<div id="control" class="form-row">
				<h4 class="col-md-6 mb-3">Control Data<span style="font-size:16px;"> (optional)</span></h4>
				<label for="control_name" hidden>Control</label> 
				<input id="control_name-1" name="control-1" type="text" value="Control" class="col-md-3 mb-3" hidden>
				<br>
				<label for="control" hidden>Peptide File </label>
				<input id="control" multiple name="control-1" type="file" class="col-md-6 mb-3">	
			</div>
		</div>

		<br>

		<div class="form-row mb-3" id="motif_length_section" hidden>
			<h5 class="col-md-6">Preferred length of motifs</h5>
			<select class="col-md-3" name="motif_length" id="motif_length">
				<option value="8">8</option>
				<option value="9" selected>9</option>
			</select>
		</div>

		<div>
			<h4>MHC Binding Predictions</h4>
			
			<div class="form-row">
				<h5 class="col-md-6">Species</h5>
				<select class="col-md-3" name="species" id="species" onchange="updateSelectedMHCClass()">
					<option value="" disabled selected>Select Species</option>
				</select>
			</div>
			<br>
			
			<div class="form-row">
				<h5 class="col-md-6">MHC Class of interest</h5>
				<select class="col-md-3" name="mhc_class" id="mhc_class" disabled onchange="updateSelectedMHCClass()">
					<option value="" disabled selected>Select MHC Class</option>
				</select>
			</div>
			<br>
			
			<div class="form-row">
				<h5 class="col-md-6">Alleles</h5>

				<div class="col-md-3">
					<input 
						type="text" 
						id="alleles_search" 
						placeholder="Search alleles..." 
						onkeyup="filterAlleles()" 
						class="form-control w-100 mb-3"
					/>
					
					<select 
						name="alleles_list" 
						id="alleles_list" 
						multiple 
						size="10" 
						disabled 
						onclick="updateAllele(this)"
						class="form-control w-100"
					>
						<!-- Options can be added dynamically later -->
					</select>
				</div>
				
			</div>
			
			<br>
			    
			<div class="form-row">
				<b class="col-md-6 mb-3" id="allelestextarealabel">or type allele names separated by commas.</b>&nbsp;  <br>
				<!-- <input class="col-md-4 mb-3" name="alleles" type="text" value=""><br> -->
				<textarea id='alleles'rows="3" cols="40" name="alleles" placeholder="Enter alleles"></textarea><br>

			</div>
				
				For list of allowed allele names, click here <a id="allelesreferencefilelink" href="/static/Immunolyser2.0_Allele_Dictionary.csv" target="_blank"> for the list of MHC allele names</a>.

			</div>

			<br>
			
		</div>
	
		<p> 
		<input class="col-md-12 mb-3" id="submit" name="submit" type="submit" value="Submit">
		</p>
   </form>

</div>

<script type="text/javascript">

	// Define a global variables
	let maxLengthSampleName = parseInt("{{ sample_name_max_length }}");
	let sampleId = 1;
	let maxSamples = parseInt("{{ max_samples }}");
	let maxRows = parseInt("{{ max_total_peptides }}");
	let maxAlleles = parseInt("{{ max_alleles }}");
	const peptidesPerSample = {
		'sample_file-1': 0 // Mandatory first sample with 0 peptides to start with
	};

	// DOM Elements (Cache)
	const parentDiv = document.getElementById('samples'); // For MutationObserver : When any sample is added or remved

	// Load species and MHC class options automatically on page load
	function loadSpeciesAndMhcClasses() {
		// Load species
		$.ajax({
			url: '/get_species',  // Adjust with the correct URL for fetching species data
			type: 'POST',
			success: function (speciesData) {
				$('#species').empty().append('<option disabled selected>Select Species</option>');
				speciesData.forEach(species => {
					$('#species').append(`<option value="${species}">${species}</option>`);
				});

				// Automatically select the first species
				if (speciesData.length > 0) {
					$('#species').val(speciesData[0]).change();  // Trigger the change event
				}
			}
		});
	}

	// Event Listeners
	// Add all event listeners here or within the init function
	function addEventListeners() {
		// MutationObserver for detecting div addition/removal
		const observer = new MutationObserver(mutationCallback);
		observer.observe(parentDiv, { childList: true });

		$('#species').change(function () {
			const species = $(this).val();
			$('#mhc_class').prop('disabled', true).empty().append('<option disabled selected>Loading...</option>');
			$('#alleles_list').prop('disabled', true).empty();

			$.ajax({
				url: '/get_mhc_classes',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({ species: species }),
				success: function (classes) {
					$('#mhc_class').empty().append('<option disabled selected>Select MHC Class</option>');
					classes.forEach(cls => {
						$('#mhc_class').append(`<option value="${cls}">${cls}</option>`);
					});
					$('#mhc_class').prop('disabled', false);

					// Automatically select the first species
					if (classes.length > 0) {
						$('#mhc_class').val(classes[0]).change();  // Trigger the change event
					}
				}
			});
		});

		$('#mhc_class').change(function () {
			const species = $('#species').val();
			const mhcClass = $(this).val();
			$('#alleles_list').prop('disabled', true).empty().append('<option disabled>Loading...</option>');

			$.ajax({
				url: '/get_alleles',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({ species: species, mhc_class: mhcClass }),
				success: function (alleles) {
					$('#alleles_list').empty();
					alleles.forEach(allele => {
						$('#alleles_list').append(`<option value="${allele}">${allele}</option>`);
					});
					$('#alleles_list').prop('disabled', false);
				}
			});
		});

	}

	function addSample() {
		if (sampleId >= maxSamples) {
			alert('You cannot add more than ' + maxSamples + ' samples.');
			return;
		}
		var samples = document.getElementById('samples');
		var sample = document.getElementById('sample');

		sampleId++;
		var cln = sample.cloneNode(true);
		cln.children[1].name = "sample-" + sampleId;
		cln.children[1].id = "sample_name-" + sampleId;
		cln.children[1].value = "";
		cln.children[4].name = "sample-" + sampleId;
		cln.children[4].id = "sample_file-" + sampleId;
		cln.children[4].value = "";
		cln.children[4].setAttribute('onchange', 'calculateNumberOfPeptidesInCsv(event)');
		samples.appendChild(cln);

		// Update dictionary tracking number of pepitdes
		peptidesPerSample[cln.children[4].id] = 0;
	}

	// Functions
	// Callback for MutationObserver : Keeping track when sample is added or removed
	function mutationCallback(mutationsList) {
		for(const mutation of mutationsList) {
			if (mutation.type === 'childList') {

				for (const removedNode of mutation.removedNodes) {
					if (removedNode.id) {
						// Updating dictionary tracking number of peptides
						// Removing entry tracking sample being removed
						delete peptidesPerSample[removedNode.children[4].id];
					}
				}

			}
		}
	}

	function deleteSample() {
		if (sampleId > 1) {
			var select = document.getElementById('samples');
			
			// Updating dictionary tracking number of peptides
			// Removing entry tracking sample being removed
			delete peptidesPerSample[select.lastChild.children[4].id];

			select.removeChild(select.lastChild);

			sampleId--;
		} else {
			alert('Analysis requires at least one sample.');
		}
	}

	// Handler for file input change
	function calculateNumberOfPeptidesInCsv(event) {

		var totalRows = 0;
		const files = event.target.files;
		let filesProcessed = 0;

		// Check if no files are attached
		if (files.length === 0) {
			peptidesPerSample[event.target.id] = 0;
			return;
		}

		showSpinner(true);

		try {
			// Loop through each file
			for (let i = 0; i < files.length; i++) {
				const file = files[i];

				// Create a FileReader to read the file
				const reader = new FileReader();

				// Define the onload function to handle the file once it's read
				reader.onload = function(e) {
					var rows = e.target.result.split('\n').length - 1; // subtract 1 for header
					totalRows += rows;
					filesProcessed++;

					// Once all files have been processed, update the dictionary
					if (filesProcessed === files.length) {
						peptidesPerSample[event.target.id] = totalRows;
						showSpinner(false);
					}
				};

				// Read the file as text (you can also use readAsArrayBuffer, readAsBinaryString, etc.)
				reader.readAsText(file);
			}

		} 
		catch (error) {
			console.error('Error reading files:', error);
			showSpinner(false);
		}
	}

	var allele_warning = false
	function updateAllele(element){
		alleleText = document.getElementsByName('alleles')[0];
		
		for (i = 0; i < element.options.length; i++) {
			if (element.options[i].selected) {
				alleleValue = element.options[i].value;
				
				if (alleleText.value == '') {
					alleleText.value = alleleValue;
				} 
				else if (allelePresent(alleleValue)){
					continue;
				}
				
				else {
					alleleText.value += "," + alleleValue;
				}
			}
		}
	}

	function allelePresent(allele) {
		alleles = document.getElementsByName('alleles')[0].value;
		
		return alleles.includes(allele)
	}

	function checkAlleles(){

		showSpinner();

		namereplication = checkSampleReplication();
		if(namereplication==false){
			return false;
		}

		samples = document.getElementById('samples').getElementsByTagName('div');

		for (i=0;i<samples.length;i++){
			sample = samples[i].getElementsByTagName('input');
			sample_name = sample[0];

			// console.log(sample_name)
			if(checkSampleName(sample_name.value)==false){
				return false;
			}
			
			sample_data = sample[1];
			if(checkSampleFiles(sample_data, true)==false){
				return false;
			}
		}

		control = document.getElementById('control').getElementsByTagName('input')[1];
		if(checkSampleFiles(control)==false){
			return false;
		}


		// Validating number of peptides being uploaded

		// Calculate the sum of values in the dictionary
		const totalPeptides = Object.values(peptidesPerSample).reduce((sum, value) => sum + value, 0);
    
		// Compare the total with maxRows
		if (totalPeptides > maxRows) {
			showSpinner(false);
			alert(`Total peptides ${totalPeptides} exceed the maximum allowed ${maxRows}.`);
			return false;
		}

		alleleText = document.getElementById('alleles');
		
		var selected_class = document.getElementById("mhc_class").value;
		// Warning to select alleles
		if (alleleText.value.length==0){
			if(allele_warning==false){
				showSpinner(false);
				alert('If the form is submitted without the allele names, no binding prediction will be performed');
				allele_warning = true;
				return false;
			}
		}

		var alleleText = document.forms["login"]["alleles"].value;

		if(alleleText ==""){
			return true;
		}

		alleleList = alleleText.split(",");
		var uniqueAlleles = alleleList.filter((v, i, a) => a.indexOf(v) === i);


		// Removing repeating alleles
		document.forms["login"]["alleles"].value = uniqueAlleles.join();
		
		var validAlleles = new Array();
		$('#alleles_list option').each(function () {
			var alleleValue = $(this).val();
			if (alleleValue) { // Ensure it's not an empty option
				validAlleles.push(alleleValue);
			}
		});

		// Check if there are any valid alleles
		if (validAlleles.length === 0) {
			// Alert the user to select species and class of interest
			alert("Please select a Species and MHC Class of interest first.");	
			showSpinner(false);
			return false;  // Prevent further execution
		}

		for(var i=0; i<uniqueAlleles.length; i++){
			if(validAlleles.includes(uniqueAlleles[i]) == false){
				showSpinner(false);
				alert(uniqueAlleles[i]+" is not a supported allele.");
				return false;
			};
		}

		// Limit number of alleles
		if (uniqueAlleles.length > maxAlleles) {
			showSpinner(false);
			alert(`Please enter no more than ${maxAlleles} alleles.`);
			return false;
		}
		
		return true;
	}

	function showSpinner(flag=true){
		var nodes = document.getElementById("main-content").getElementsByTagName('*');
		
		if(flag){
			// for(var i = 0; i < nodes.length; i++){
			// 	nodes[i].disabled = true;
			// }

			document.getElementById("main-content").style.opacity = 0.2;
			document.getElementById('lds-hourglass').hidden = false;
		}
		
		else{
			// for(var i = 0; i < nodes.length; i++){
			// 	nodes[i].disabled = false;
			// }

			document.getElementById("main-content").style.opacity = 1;
			document.getElementById('lds-hourglass').hidden = true;
		}
	}

	function checkSampleName(sample_name){

		if (sample_name==''){
			showSpinner(false);
			alert('Please enter a name each of the sample.');
			return false;
		}

		if(validateAlphanumeric(sample_name)== false){
			showSpinner(false);
			alert("Invalid input. Sample name should only contain alphanumeric characters.");
			return false;
		}
		
		if (validateStringLength(sample_name) == false){
			showSpinner(false);
			alert("Invalid input. Please enter a sample name with a maximum length of " + maxLengthSampleName + " characters.");
			return false;
		}

		return true;
	}

	function validateAlphanumeric(input) {
		// Define a regular expression for alphanumeric characters
		var alphanumericRegex = /^[a-zA-Z0-9_]+$/;

		// Test the input against the regular expression
		return alphanumericRegex.test(input);
    }

	function validateStringLength(input) {
		// Check if the input length is within the specified limit
		return input.length <= maxLengthSampleName;
    }

	var col_warning = false
	cols = ['Peptide'];
	colsnotpresent = [];
	var name = '';

	function checkSampleFiles(sample_files, required = false){

		if(sample_files.value=='' && required == true){
			showSpinner(false);
			alert('Please upload the data file(csv).');
			return false;
		}

		for(i=0;i<sample_files.files.length;i++){

			name = sample_files.files[i].name;

			if(name.substr(-4)!='.csv'){
				showSpinner(false);
				alert('Cannot accept ' + name + ' file as it is not a csv file.');
				return false;
			}
			
			let reader = new FileReader();
			reader.readAsText(sample_files.files[i]);

			reader.onload = function() {

				colseread = reader.result.split('\n')[0].replace('\r','').replaceAll("\"",'').split(',');



				for (i=0;i<cols.length;i++){

					flag = false;

					for (j=0;j<colseread.length;j++){
						if(colseread[j] !== cols[i]){
							continue;
						}
						else{
							flag = true;
						}
					}

					if(!flag){
						colsnotpresent.push(cols[i]);
					}

					// if (!colseread.includes(cols[i])){
					// 	colsnotpresent.push(cols[i]);
					// }
				}
				if(colsnotpresent.length != 0) {
					col_warning = true;
				}
			};

			if (col_warning){
				col_warning=false;
				showSpinner(false);
				alert(name + ' does not contains following column(s): '+ colsnotpresent.join(', '));
				colsnotpresent = [];
				return false;
			}
			
		}

		return true;
		
	}

	function checkSampleReplication(){
		samples = document.getElementById('samples');

		sample_names = [];

		for(i=1;i<=samples.children.length;i++){
			// name = document.getElementById('sample_name-'.concat(i))
			// console.log(name);
			if(document.getElementById('sample_name-'.concat(i))){
				name = document.getElementById('sample_name-'.concat(i)).value;

				if(sample_names.includes(name)){
					showSpinner(false);
					alert('All the sample names should be different.');
					return false;
				}
				else{
					sample_names.push(name.trim());
				}
			}
		}

		return true;
	}

	function updateSelectedMHCClass() {

		// Resetting Allele warning flag
		allele_warning = false;
		
		// Clear selected alleles input text area
		document.getElementsByName('alleles')[0].value = '';

		// Get the value of the selected MHC Class
		var mhcClass = document.getElementById("mhc_class").value;
    
		// Get the "Preferred length of motifs" section
		var motifLengthSection = document.getElementById("motif_length_section");

		// Show or hide the "Preferred length of motifs" section based on the MHC Class
		if (mhcClass === "I") {
			motifLengthSection.removeAttribute("hidden"); // Show if MHC Class is I
		} else {
			motifLengthSection.setAttribute("hidden", true); // Hide if MHC Class is not I
		}
	}

	function filterAlleles() {
		const searchInput = document.getElementById('alleles_search').value.toLowerCase();
		const selectBox = document.getElementById('alleles_list');
		const options = selectBox.options;

		for (let i = 0; i < options.length; i++) {
			const option = options[i];
			const text = option.text.toLowerCase();
			option.style.display = text.includes(searchInput) ? '' : 'none';
		}
	}

	// Initialization
	function init() {
		addEventListeners();
		// Additional initialization logic if needed

		loadSpeciesAndMhcClasses();
	}

	// Ensure the DOM is fully loaded before initializing
	document.addEventListener('DOMContentLoaded', init);

</script>
{% endblock %}
